name: ML Pipeline CI/CD

on:
  push:
    paths:
      - 'mlops/**'
      - 'services/embedding_service.py'
      - 'services/query_generator.py'
      - 'prompts/**'
  pull_request:
    paths:
      - 'mlops/**'
      - 'services/embedding_service.py'
      - 'services/query_generator.py'
      - 'prompts/**'
  schedule:
    # Run ML pipeline tests daily
    - cron: '0 3 * * *'

env:
  PYTHON_VERSION: '3.9'
  MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}

jobs:
  # ML Model Validation
  ml-model-validation:
    name: ML Model Validation
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    services:
      mongodb:
        image: mongo:6.0
        env:
          MONGO_INITDB_ROOT_USERNAME: test
          MONGO_INITDB_ROOT_PASSWORD: test
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install ML dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-ml.txt
        pip install mlflow[extras] sentence-transformers scikit-learn
    
    - name: Set up test environment
      run: |
        export MONGODB_URI="mongodb://test:test@localhost:27017/test_db?authSource=admin"
        export REDIS_HOST="localhost"
        export REDIS_PORT="6379"
        export MLFLOW_TRACKING_URI="sqlite:///mlflow.db"
        echo "MONGODB_URI=mongodb://test:test@localhost:27017/test_db?authSource=admin" >> $GITHUB_ENV
        echo "REDIS_HOST=localhost" >> $GITHUB_ENV
        echo "REDIS_PORT=6379" >> $GITHUB_ENV
        echo "MLFLOW_TRACKING_URI=sqlite:///mlflow.db" >> $GITHUB_ENV
    
    - name: Test feature store
      run: |
        python -m pytest tests/test_feature_store.py -v --tb=short
    
    - name: Test embedding pipeline
      run: |
        python -m pytest tests/test_embedding_pipeline.py -v --tb=short
    
    - name: Test model performance
      run: |
        python -m pytest tests/test_model_performance.py -v --tb=short
    
    - name: Validate model outputs
      run: |
        python tests/validate_model_outputs.py --comprehensive

  # Model Training and Evaluation
  model-training:
    name: Model Training & Evaluation
    runs-on: ubuntu-latest
    needs: [ml-model-validation]
    timeout-minutes: 60
    
    services:
      mongodb:
        image: mongo:6.0
        env:
          MONGO_INITDB_ROOT_USERNAME: test
          MONGO_INITDB_ROOT_PASSWORD: test
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install ML dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-ml.txt
        pip install mlflow[extras] sentence-transformers scikit-learn
    
    - name: Set up MLflow
      run: |
        export MLFLOW_TRACKING_URI="sqlite:///mlflow.db"
        mlflow experiments create --experiment-name "ci-training"
        echo "MLFLOW_TRACKING_URI=sqlite:///mlflow.db" >> $GITHUB_ENV
    
    - name: Train and evaluate model
      run: |
        python mlops/training/train_model.py \
          --experiment-name "ci-training" \
          --data-path "tests/data/sample_queries.json" \
          --output-path "model_artifacts"
    
    - name: Validate model quality
      run: |
        python mlops/training/validate_model.py \
          --model-path "model_artifacts" \
          --test-data "tests/data/test_queries.json" \
          --min-accuracy 0.8
    
    - name: Upload model artifacts
      uses: actions/upload-artifact@v3
      with:
        name: model-artifacts
        path: model_artifacts/
        retention-days: 7

  # Model Registry Update
  model-registry:
    name: Model Registry Update
    runs-on: ubuntu-latest
    needs: [model-training]
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 20
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download model artifacts
      uses: actions/download-artifact@v3
      with:
        name: model-artifacts
        path: model_artifacts/
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install ML dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install mlflow[extras]
    
    - name: Update model registry
      run: |
        export MLFLOW_TRACKING_URI="${{ env.MLFLOW_TRACKING_URI }}"
        python mlops/registry/update_model_registry.py \
          --model-path "model_artifacts" \
          --model-name "mongodb-query-translator" \
          --stage "staging" \
          --description "CI/CD trained model - ${{ github.sha }}"
    
    - name: Run model comparison
      run: |
        export MLFLOW_TRACKING_URI="${{ env.MLFLOW_TRACKING_URI }}"
        python mlops/registry/compare_models.py \
          --model-name "mongodb-query-translator" \
          --baseline-stage "production" \
          --candidate-stage "staging"

  # A/B Testing Setup
  ab-testing:
    name: A/B Testing Setup
    runs-on: ubuntu-latest
    needs: [model-registry]
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install mlflow[extras]
    
    - name: Configure A/B test
      run: |
        export MLFLOW_TRACKING_URI="${{ env.MLFLOW_TRACKING_URI }}"
        python mlops/ab_testing/setup_ab_test.py \
          --model-name "mongodb-query-translator" \
          --traffic-split 0.1 \
          --duration-days 7 \
          --metrics "accuracy,latency,user_satisfaction"

  # Model Monitoring Setup
  model-monitoring:
    name: Model Monitoring Setup
    runs-on: ubuntu-latest
    needs: [ab-testing]
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install mlflow[extras] prometheus-client
    
    - name: Set up model monitoring
      run: |
        export MLFLOW_TRACKING_URI="${{ env.MLFLOW_TRACKING_URI }}"
        python mlops/monitoring/setup_model_monitoring.py \
          --model-name "mongodb-query-translator" \
          --monitoring-interval 300 \
          --alert-thresholds '{"accuracy": 0.8, "latency": 5.0}'

  # Notify ML Pipeline Results
  notify-results:
    name: Notify ML Pipeline Results
    runs-on: ubuntu-latest
    needs: [model-monitoring]
    if: always()
    timeout-minutes: 5
    
    steps:
    - name: Notify ML pipeline completion
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#mlops-pipeline'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        fields: repo,message,commit,author,action,eventName,ref,workflow
        custom_payload: |
          {
            "text": "ðŸ¤– ML Pipeline Completed",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*ML Pipeline Results:*\nâ€¢ Model Validation: ${{ needs.ml-model-validation.result }}\nâ€¢ Model Training: ${{ needs.model-training.result }}\nâ€¢ Model Registry: ${{ needs.model-registry.result }}\nâ€¢ A/B Testing: ${{ needs.ab-testing.result }}\nâ€¢ Monitoring: ${{ needs.model-monitoring.result }}"
                }
              }
            ]
          }
